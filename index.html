<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kuis Nahwu</title>

<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">

<style>
/* ... semua CSS asli tetap sama ... */
</style>
</head>

<body>
<div class="quiz-box">

  <div id="timerBox">
    ⏳ Waktu: <span id="timeNum">20</span> detik
    <div id="progressWrap"><div id="progressBar"></div></div>
  </div>
  
  <div id="startScreen">
  <h2 style="text-align:center;margin-bottom:20px;">
    Sudah siap?
  </h2>
  <button id="startBtn">Mulai</button>
</div>

  <div id="quiz" class="hidden">
    <div id="questionText"></div>
    <div id="answers" class="answer-buttons"></div>

    <div class="score-board">
      Skor: <b id="scoreNum">0</b> / 100<br>
      Benar: <span id="cNum">0</span> | Salah: <span id="wNum">0</span>
    </div>

    <div id="result" class="hidden"></div>
    <button id="nextBtn" class="hidden">Soal Selanjutnya</button>
  </div>
</div>

<audio id="tickSound" src="tick.mp3" preload="auto"></audio>
<audio id="alarmSound" src="alarm.mp3" preload="auto"></audio>

<script>
const POINT = 5;
const TIME_LIMIT = 20000;

/* ===== VARIABEL ASLI ===== */
let data = [], idx = 0, score = 0, correct = 0, wrongCount = 0, wrong = [];
let currentOptions = [];
let timer = null;
let timerActive = false;

/* ===== TIMER ===== */
const timeNum = document.getElementById("timeNum");
const progressBar = document.getElementById("progressBar");
const tickSound = document.getElementById("tickSound");
const alarmSound = document.getElementById("alarmSound");

/* ===== ELEMENT ===== */
const scoreNum = document.getElementById("scoreNum");
const cNum = document.getElementById("cNum");
const wNum = document.getElementById("wNum");
const questionText = document.getElementById("questionText");
const answers = document.getElementById("answers");
const result = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");
const quiz = document.getElementById("quiz");
const quizBox = document.querySelector(".quiz-box");
const startScreen = document.getElementById("startScreen");
const startBtn = document.getElementById("startBtn");
startBtn.disabled = true; // disable dulu

fetch("soal.json")
  .then(r => r.json())
  .then(d => {
    data = d;
    startBtn.disabled = false; // enable start setelah data siap
  })
  .catch(e => {
    alert("Gagal memuat soal.json");
    console.error(e);
  });

const timerBox = document.getElementById("timerBox");
timerBox.classList.add("hidden");

/* ===== TIMER ASLI + VISUAL ===== */
function startTimer(){
  clearTimeout(timer);

  timerActive = true;
  quizBox.classList.remove("timer-warning","alarm-on");
  timeNum.parentElement.classList.remove("danger");

  let remaining = TIME_LIMIT/1000;
  timeNum.textContent = remaining;
  progressBar.style.width="100%";

  const countdownInterval = setInterval(()=>{
    if(!timerActive)return;

    remaining--;
    timeNum.textContent = remaining;
    progressBar.style.width = (remaining/(TIME_LIMIT/1000))*100+"%";

    progressBar.classList.remove("progress-safe","progress-warn","progress-danger");

    if(remaining>10){
      progressBar.classList.add("progress-safe");
    }else if(remaining>5){
      progressBar.classList.add("progress-warn");
    }else{
      progressBar.classList.add("progress-danger");
    }

    if(remaining>0){
      tickSound.currentTime=0;
      tickSound.play();
    }

    if(remaining<=5 && !quizBox.classList.contains("alarm-on")){
      quizBox.classList.add("timer-warning","alarm-on");
      timeNum.parentElement.classList.add("danger");
      alarmSound.currentTime=0;
      alarmSound.play();
    }

    if(remaining<=0)clearInterval(countdownInterval);
  },1000);

  timer=setTimeout(()=>{if(timerActive)timeUp()},TIME_LIMIT);
}

function pauseTimer(){
  timerActive=false;
  clearTimeout(timer);
  tickSound.pause();
  alarmSound.pause();
}

/* ===== LOGIKA ASLI ===== */
function show(){
  const q=data[idx];
  result.classList.remove("show");
  questionText.innerText=`Soal ${idx+1}: ${q.question}`;
  answers.innerHTML="";

  startTimer();

  currentOptions=["A","B","C","D","E"].map((l,i)=>({
    text:q["option_"+l],
    isCorrect:i===Number(q.answer_index)
  }));

  shuffle(currentOptions);

  currentOptions.forEach(opt=>{
    const b=document.createElement("button");
    b.textContent=opt.text;
    b.onclick=()=>check(b,opt);
    answers.appendChild(b);
  });

  result.classList.add("hidden");
  nextBtn.classList.add("hidden");
}

function check(btn,opt){
  if(!timerActive)return;
  pauseTimer();

  const q=data[idx];
  [...answers.children].forEach((b,i)=>{
    if(currentOptions[i].isCorrect)b.classList.add("correct");
    if(b===btn&&!opt.isCorrect)b.classList.add("wrong");
    b.disabled=true;
  });
  
  result.classList.remove("hidden");
  requestAnimationFrame(()=>result.classList.add("show"));

  if(opt.isCorrect){
    correct++;score+=POINT;
    result.innerHTML=`<div class="correct-text">✔ Jawaban Benar</div><div class="explain">${q.explanation}</div>`;
  }else{
    wrongCount++;
    result.innerHTML=`<div class="wrong-text">✖ Jawaban Salah</div><div class="explain">${q.explanation}</div>`;
  }

  scoreNum.textContent=score;
  cNum.textContent=correct;
  wNum.textContent=wrongCount;
  nextBtn.classList.remove("hidden");
  setTimeout(()=>{
  result.scrollIntoView({
    behavior: "smooth",
    block: "center"
  });
}, 150);
}

function timeUp(){
  pauseTimer();
  wrongCount++;
  const q=data[idx];
  result.classList.remove("hidden");
  requestAnimationFrame(()=>result.classList.add("show"));
  result.innerHTML=`<div class="wrong-text">⏰ Waktu habis</div><div class="explain">${q.explanation}</div>`;
  wNum.textContent=wrongCount;
  nextBtn.classList.remove("hidden");
  setTimeout(()=>{
  result.scrollIntoView({
    behavior: "smooth",
    block: "center"
  });
}, 150);
}

nextBtn.onclick=()=>{
  idx++;
  if(idx<data.length)show();
};

window.addEventListener("load",()=>{
  document.body.classList.add("page-ready");
});

startBtn.onclick = () => {
  startScreen.classList.add("hidden");
  quiz.classList.remove("hidden");
  timerBox.classList.remove("hidden");

  idx = 0;
  show();
};

/* ===== UTILITY ===== */
function shuffle(array){for(let i=array.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}
</script>
</body>
</html>
